# HyperDash - Design Rules & Guidelines

## IMPORTANT: Rules File Maintenance

**After making any changes to the codebase, ALWAYS ask the user:**
"Do you want me to update the .cursorrules file with any new patterns, conventions, or SOPs that were established?"

## Project Overview

Reactive personal dashboard webapp. Built with Next.js 15, TypeScript, Tailwind CSS, and React.

## Core Principles

1. **Wallpaper Reactive**: Borders use white/neutral colors; text colors dynamically adjust based on wallpaper brightness
2. **Consistency**: Unified color scheme across all widgets
3. **Modern Aesthetic**: Monospace fonts, thin borders, semi-transparency, backdrop blur
4. **Accessibility**: Good contrast ratios, automatically optimized per wallpaper

## Styling System

### Reactive Color System

**CRITICAL**: Text colors dynamically adjust to wallpaper brightness. Use `useReactiveColors()` hook - NEVER hardcoded Tailwind green classes.

**Color Palette** (via `useReactiveColors()` hook):
- `colors.primary` - Main content text (green-300 equivalent, dynamically adjusted)
- `colors.secondary` - Labels, headings (green-400 equivalent)
- `colors.placeholder` - Input placeholders (green-500/80 equivalent, auto-styled via CSS)
- `colors.muted` - Completed/strikethrough items (green-600 equivalent)
- `colors.button` - Button labels (green-300 equivalent)

**Default Fallback Colors**:
- Primary: `rgb(134, 239, 172)`
- Secondary: `rgb(74, 222, 128)`
- Placeholder: `rgba(34, 197, 94, 0.8)`
- Muted: `rgb(22, 163, 74)`
- Button: `rgb(134, 239, 172)`

**Implementation**: Wallpaper analyzed via canvas API → brightness calculated → RGB adjusted while preserving hue. Colors stored in React Context (`ColorContext.tsx`) and persisted to localStorage. CSS custom properties set for global access.

### Borders (Unified Neutral)

**NEVER use colored borders** - All borders must be white/neutral:
- Default: `border-white/20`
- Hover/Focus: `border-white/50`
- Dividers: `border-white/10`

### Backgrounds

- Widgets: `bg-black/40 backdrop-blur-xl`
- Inputs: `bg-black/10`
- Buttons: `bg-white/10`, hover: `bg-white/15`
- Modals: `bg-black/40 backdrop-blur-xl`

### Shadows & Scrollbar

- Widget shadow: Standard dark with subtle inset highlight
- Button hover: `hover:shadow-white/20`
- Input shadow: `inset 0 1px 2px rgba(0, 0, 0, 0.3)`
- Scrollbar thumb: `rgba(255, 255, 255, 0.2)`, hover: `rgba(255, 255, 255, 0.4)`

## Widget Architecture

### Three-Layer System

1. **Dashboard** (`app/components/Dashboard.tsx`): Manages widget configuration, layout slots, widget props via `getWidgetProps()`
2. **WidgetContainer** (`app/components/WidgetContainer.tsx`): Lazy loads widgets, handles empty slots, passes focus props. **Always give each slot wrapper `className="h-full min-h-0"` so child widgets use their own scrollbars instead of stretching the layout.**
3. **Widget** (`app/components/[WidgetName]Widget.tsx`): Individual components using base `Widget` component

### Widget Registry (`app/lib/widgetRegistry.ts`)

- `WidgetType`: Union type `'clock' | 'weather' | 'system' | 'todo' | 'notepad'`
- Dynamic import registry for code splitting
- Type-safe widget loading

### Widget Configuration (`app/lib/widgetConfig.ts`)

- **WidgetSlot**: `{ position: number, widgetType: WidgetType | null }`
- **WidgetConfiguration**: Array of `WidgetSlot` objects
- Persisted to localStorage (`'hyperdash-widget-config'`)
- Positions numbered left-to-right, top-to-bottom (1-3 = top row, 4-5 = bottom row)
- Default: Clock(1), Weather(2), System(3), Todo(4), Notepad(5)

**Key Functions**:
- `getWidgetConfiguration()` - Loads from localStorage or returns default
- `saveWidgetConfiguration(config)` - Saves to localStorage
- `getFocusablePositions(config)` - Returns focusable positions (skips empty slots)
- `getNextFocusPosition(current, config, direction)` - Calculates next/prev for Tab cycling

### Base Widget Component (`app/components/Widget.tsx`)

All widgets use base `Widget` component:
- Unified styling: `border-white/20`, `bg-black/40 backdrop-blur-xl`
- Focus styling: `border-white/50`, `-translate-y-[1px]`, `shadow-xl` (only when `isFocused={true}`)
- Transition: `transition-all duration-150` for fast visual feedback
- No hover effects: Visual focus indicators only appear when widget has focus
- Inner glow: Subtle inner glow effect when focused (`inset 0 0 20px rgba(255, 255, 255, 0.1)`)

## Focus System (Hyprland-Style)

**Architecture**: Click-based focus system. Focus is established by clicking on widgets, not hovering.

**FocusContext** (`app/components/FocusContext.tsx`):
- `focusedPosition: number | null` - Currently focused widget (1-5)
- `setFocusedPositionFromKeyboard(position)` - Sets focus from keyboard navigation
- `setFocusedPositionFromMouse(position)` - Sets focus from mouse click

**Keyboard Shortcuts** (`app/lib/useKeyboardShortcuts.ts`):
- `1-9`: Direct focus to widget position (skips empty slots)
- `Tab`: Cycle forward through widgets (wraps around)
- `Shift+Tab`: Cycle backward (wraps around)
- Disabled when editing text (inputs, textareas, contenteditable)

**Widget-Specific Shortcuts** (`app/lib/useWidgetKeyboardShortcuts.ts`):
- Reusable hook for widget-specific keyboard shortcuts
- Only active when widget is focused (`isFocused={true}`)
- Automatically disabled when editing text
- Ignores modifier keys (CMD/Ctrl/Alt) to prevent browser conflicts
- Shift is allowed for intentional shortcuts

**Integration**:
- Dashboard wraps with `<FocusProvider>`, passes `isFocused` to WidgetContainer
- WidgetContainer handles `onMouseDown` → `setFocusedPositionFromMouse()` (click-based)
- Widget components accept `isFocused?: boolean` prop, pass to base `Widget`
- Base `Widget` applies focus styling only when `isFocused={true}` (no hover effects)
- Transition duration: `duration-150` for fast visual feedback

**Adding Focus to New Widgets**: Accept `isFocused?: boolean` prop → pass to base `<Widget>` component. No additional logic needed.

**Adding Widget Shortcuts**: Use `useWidgetKeyboardShortcuts(isFocused, shortcuts)` hook with a `shortcuts` object mapping key strings to handler functions.

## Widget Requirements

### All Widgets Must:
1. Use base `Widget` component
2. Accept and pass `isFocused?: boolean` prop
3. Use `useReactiveColors()` hook for colors (inline styles: `style={{ color: colors.primary }}`)
4. NEVER use hardcoded Tailwind green classes (`text-green-300`, etc.)
5. Proper height constraints for scrolling (`flex-1 min-h-0`)
6. Neutral white borders only

### Input Fields Must:
- `border-white/20`, focus: `border-white/50`
- `bg-black/10`
- `style={{ color: colors.primary }}`
- Placeholder auto-styled via CSS custom property

### Buttons Must:
- `bg-white/10`, hover: `bg-white/15`
- `border-white/30`, hover: `border-white/50`
- `style={{ color: colors.button }}`

## Adding New Widgets

### Step 1: Create Widget Component
- File: `app/components/[WidgetName]Widget.tsx`
- Use base `Widget` component
- Accept `isFocused?: boolean` prop
- Use `useReactiveColors()` hook
- Apply colors via inline styles

### Step 2: Register Widget Type
- Add to `WidgetType` union in `app/lib/widgetRegistry.ts`
- Add dynamic import to `widgetComponents` registry

### Step 3: Register in WidgetContainer
- Add lazy import to `lazyWidgets` object in `app/components/WidgetContainer.tsx`

### Step 4: Optional Configuration
- Add to `DEFAULT_CONFIGURATION` in `app/lib/widgetConfig.ts` if desired

### Step 5: Widget Props (If Needed)
- Add to `getWidgetProps()` in `app/components/Dashboard.tsx` for Dashboard callbacks

## Common Patterns

### Scrollable Container
```tsx
<div className="flex-1 overflow-y-auto min-h-0">
  {/* Content */}
</div>
```

### Input Field
```tsx
import { useReactiveColors } from './ColorContext';

const { colors } = useReactiveColors();
<input
  className="bg-black/10 border border-white/20 focus:border-white/50"
  style={{ color: colors.primary }}
/>
```

### Button
```tsx
import { useReactiveColors } from './ColorContext';

const { colors } = useReactiveColors();
<button
  className="bg-white/10 border border-white/30 hover:bg-white/15 hover:border-white/50"
  style={{ color: colors.button }}
>
  Button Text
</button>
```

### Drag-and-Drop Reordering

**State**: Track `draggedId` and `dragOverId`, reset on `dragEnd`/`drop`

**Visual Reordering**: Implement `getDisplayTodos()` that reorders array based on drag state. Render using this function during drag.

**Hide Drag Ghost**:
```tsx
const canvas = document.createElement('canvas');
canvas.width = 1; canvas.height = 1;
e.dataTransfer.setDragImage(canvas, 0, 0);
```

**Pattern**: Drag handle (grid dots SVG) left of action buttons. Use `cursor-grab`, `active:cursor-grabbing`. Enhanced border/shadow on dragged item. `transition-all duration-200`.

### ContentEditable with Links

**Image Links in Notepad**: When adding clickable links to contentEditable elements:

**Link Creation**:
- Create `<a>` elements with blob URLs for images
- Links should behave like normal text (deletable, selectable)
- Use `window.open()` in click handlers to open links in new tabs
- Check for text selection before preventing default (allow normal editing)
- Use class `notepad-image-link` for image links

**URL Links in Notepad**:
- When pasting URLs, automatically convert to shortened hyperlinks
- Display format: `[domain.com]` (e.g., `[youtube.com]`)
- Use class `notepad-url-link` for URL links
- Extract domain using `URL` API, remove `www.` prefix
- Normalize URLs (add `https://` if missing)
- Links open in new tabs when clicked

**Renumbering Pattern**:
- Track link count with refs to avoid unnecessary renumbering
- Only renumber when link count changes, not on every input
- Use `requestAnimationFrame` and preserve/restore selection during renumbering
- Prevent infinite loops by checking if renumbering is already in progress

**Example**:
```tsx
const isRenumberingRef = useRef(false);
const previousLinkCountRef = useRef(0);

const handleInput = () => {
  if (isRenumberingRef.current) return;
  // ... save content ...
  const links = editorRef.current.querySelectorAll('a.notepad-image-link');
  if (links.length !== previousLinkCountRef.current) {
    requestAnimationFrame(() => renumberImageLinks(true));
  }
};
```

**Paste Handler Pattern**:
- Check for images first (clipboardData.items)
- Then check for URLs (isURL helper function)
- Finally paste as plain text
- Use `document.execCommand('insertText')` for plain text insertion

## File Structure

```
app/
  components/
    Widget.tsx          # Base widget component
    Dashboard.tsx       # Layout, widget config, focus management
    WidgetContainer.tsx # Lazy loading, focus events (click-based)
    ColorContext.tsx    # Reactive color provider
    FocusContext.tsx    # Global focus state
    [WidgetName]Widget.tsx
  lib/
    widgetRegistry.ts      # Widget types, dynamic imports
    widgetConfig.ts        # Configuration, focus helpers
    colorUtils.ts          # Wallpaper analysis
    useKeyboardShortcuts.ts # Global shortcuts
    useWidgetKeyboardShortcuts.ts # Widget-specific shortcuts hook
  globals.css              # Global styles, CSS custom properties
```

## Widget-Specific Features

### Todo Widget

**Keyboard Shortcuts** (when focused, not editing):
- `N` - Focus input, clear selection
- `C` - Toggle show/hide completed todos
- `X` - Clear all completed (confirmation dialog)
- `Arrow Down/Up` - Navigate todos (wraps around)
- `Enter` - Edit selected todo (or focus input if none selected)
- `Space` - Toggle completion (moves to next incomplete todo)
- `Backspace` - Delete selected todo (confirmation dialog)
- `Escape` - Close dialogs, clear selection
- `Arrow Down` from input - Move to first todo
- `Arrow Up` from first todo - Move to input

**Behavior**:
- New todos added to top of list
- Completing a todo moves focus to next incomplete todo (or input if none)
- Hiding completed todos returns focus to input if selection is on completed todo
- Confirmation dialogs support Enter (confirm) and Escape (cancel)

### Notepad Widget

**Keyboard Shortcuts** (when focused, not editing):
- `Enter` - Focus editor
- `Ctrl+T` - New tab
- `Ctrl+W` - Close tab
- `Ctrl+R` - Rename tab
- `Ctrl+I` - Add image
- `Ctrl+Alt+Arrow` - Cycle tabs (macOS compatible)
- `Ctrl+1-9` - Switch to tab by number

**Features**:
- Maximum 9 tabs
- Paste URLs to auto-convert to shortened links `[domain.com]`
- Tab creation uses pending state to avoid race conditions
- Image and URL links behave like normal text (selectable, deletable)

### Clock Widget

**Keyboard Shortcuts** (when focused):
- `Space` - Start/Pause Pomodoro
- `R` - Reset Pomodoro
- `K` - Skip Pomodoro session
